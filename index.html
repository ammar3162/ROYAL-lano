<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>LANO | Royal Identity</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Cinzel:wght@400;700;900&family=Great+Vibes&family=Playfair+Display:ital,wght@0,900;1,900&display=swap" rel="stylesheet">

  <style>
    :root {
      --gold-foil: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
      --lano-burgundy: #6f1d1b;
      --lano-burgundy-2: #3b0f10;
      --paper-color: #f2e6d0;
      --vintage-red: #8b1f24;
      --ink: #1b1b1b;

      /* Mobile-safe sizing */
      --safe-pad: max(16px, env(safe-area-inset-left));
      --safe-top: max(16px, env(safe-area-inset-top));
      --safe-bottom: max(16px, env(safe-area-inset-bottom));
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at center, #2a0a0b 0%, #070102 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: "Amiri", serif;
      overflow: hidden;
      perspective: 1000px;
      color: var(--paper-color);
      padding: var(--safe-top) var(--safe-pad) var(--safe-bottom);
    }

    /* ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ•ÿµÿØÿßÿ± */
    #setup {
      position: absolute;
      z-index: 100;
      text-align: center;
      background: rgba(59, 15, 16, 0.92);
      padding: 44px 46px;
      border: 1px solid #bf953f;
      border-radius: 10px;
      box-shadow: 0 0 100px rgba(0,0,0,0.8);
      transition: 0.8s;
      width: min(540px, calc(100% - 28px));
      backdrop-filter: blur(6px);
    }
    .fade-out { opacity: 0; pointer-events: none; transform: scale(1.05); }

    .gold-foil-text {
      background: var(--gold-foil);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-family: 'Cinzel';
      font-weight: 900;
      letter-spacing: 3px;
    }

    .input-style {
      background: none;
      border: none;
      border-bottom: 2px solid #bf953f;
      color: #f2e6d0;
      font-size: 30px;
      font-family: 'Great Vibes', cursive;
      text-align: center;
      margin: 22px 0 10px;
      width: min(360px, 85%);
      outline: none;
    }

    .hint {
      margin-top: 10px;
      font-size: 13px;
      color: rgba(242,230,208,0.78);
      letter-spacing: 0.4px;
      line-height: 1.8;
    }

    .row-actions{
      margin-top: 18px;
      display:flex;
      gap:12px;
      justify-content:center;
      flex-wrap:wrap;
    }

    .btn {
      background: none;
      border: 1px solid #bf953f;
      color: #bf953f;
      padding: 12px 34px;
      cursor: pointer;
      font-family: 'Cinzel';
      font-size: 12px;
      transition: 0.25s;
      letter-spacing: 2px;
      border-radius: 10px;
    }
    .btn:hover { background: #bf953f; color: #120607; transform: translateY(-1px); }

    /* --- ÿßŸÑÿ™ÿ∞ŸÉÿ±ÿ© --- */
    .ticket-outer {
      width: min(920px, 100%);
      max-width: 920px;
      aspect-ratio: 2.1 / 1;
      position: relative;
      opacity: 0;
      transform: rotateY(20deg) rotateX(10deg) translateY(50px);
      transition: all 1.2s cubic-bezier(0.16, 1, 0.3, 1);
      touch-action: manipulation;
    }
    .ticket-outer.active { opacity: 1; transform: rotateY(0) rotateX(0) translateY(0); }

    .ticket-body {
      width: 100%;
      height: 100%;
      background-color: var(--paper-color);
      background-image: url("https://www.transparenttextures.com/patterns/cream-paper.png");
      border-radius: 14px;
      box-shadow: 0 40px 80px rgba(0,0,0,0.7);
      display: flex;
      position: relative;
      overflow: hidden;
      filter: drop-shadow(0 0 1px rgba(0,0,0,0.2));
      color: var(--ink);
    }

    .ticket-body::before {
      content: "";
      position: absolute;
      inset: 0;
      border: 12px solid transparent;
      border-image: repeating-linear-gradient(
        45deg,
        var(--vintage-red) 0, var(--vintage-red) 15px,
        var(--paper-color) 15px, var(--paper-color) 25px,
        #2a0a0b 25px, #2a0a0b 40px
      ) 40;
      z-index: 5;
      pointer-events: none;
    }

    .ticket-stub {
      width: 110px;
      background: linear-gradient(180deg, var(--lano-burgundy) 0%, #2a0a0b 100%);
      color: var(--paper-color);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Cinzel';
      font-size: 12px;
      letter-spacing: 4px;
      writing-mode: vertical-lr;
      border-left: 3px dashed rgba(255,255,255,0.12);
      z-index: 6;
      text-align:center;
      padding: 10px 0;
      user-select: none;
    }

    .ticket-main {
      flex: 1;
      padding: 28px 40px;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      z-index: 4;
    }

    .header-box { text-align: center; }
    .header-box h1 { font-size: 38px; margin: 0; }
    .header-box p {
      color: var(--vintage-red);
      font-size: 13px;
      font-weight: bold;
      letter-spacing: 5px;
      margin-top: 6px;
      text-transform: uppercase;
    }

    .center-content { text-align: center; width: 100%; }
    .center-content span { font-family: 'Cinzel'; font-size: 10px; color: #2a0a0b; opacity: 0.65; }
    .name-display {
      font-family: 'Great Vibes', cursive;
      font-size: 64px;
      color: #2a0a0b;
      margin: 4px 0 2px;
      filter: drop-shadow(1px 1px 0px white);
      line-height: 1.05;
    }

    .meta-row{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top: 8px;
    }
    .chip{
      border:1px solid rgba(42,10,11,0.18);
      background: rgba(255,255,255,0.65);
      padding: 7px 11px;
      border-radius: 999px;
      font-family: 'Cinzel';
      font-size: 10px;
      letter-spacing: 1px;
      color: rgba(42,10,11,0.85);
      user-select: none;
    }
    .chip b{ color: #2a0a0b; }

    /* ÿÆÿ™ŸÖ ÿ®ÿµÿ±Ÿä */
    .stamp-track{
      margin-top: 12px;
      display:flex;
      gap:7px;
      justify-content:center;
      flex-wrap:wrap;
      max-width: 520px;
      padding: 0 8px;
    }
    .dot{
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 1px solid rgba(42,10,11,0.28);
      background: rgba(255,255,255,0.45);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.4);
    }
    .dot.filled{
      background: linear-gradient(135deg, rgba(191,149,63,0.95), rgba(252,246,186,0.95));
      border-color: rgba(0,0,0,0.25);
    }

    .footer-row {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      border-top: 1px solid rgba(0,0,0,0.12);
      padding-top: 18px;
      gap: 16px;
    }

    .barcode-section {
      text-align: center;
      cursor: pointer;
      padding: 10px 12px;
      transition: 0.25s;
      user-select: none;
      border-radius: 12px;
      -webkit-tap-highlight-color: transparent;
    }
    .barcode-section:active { transform: translateY(-2px) scale(0.99); }

    .barcode-img {
      width: 200px;
      height: 50px;
      background: #000;
      mask: repeating-linear-gradient(90deg, #000 0, #000 2px, transparent 2px, transparent 6px);
      -webkit-mask: repeating-linear-gradient(90deg, #000 0, #000 2px, transparent 2px, transparent 6px);
      border-radius: 2px;
    }

    .mini-actions{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-start;
      flex-wrap:wrap;
      font-family: 'Cinzel';
      font-size: 10px;
      letter-spacing: 1px;
      color: rgba(0,0,0,0.55);
      user-select: none;
    }

    .mini-btn{
      background:none;
      border: 1px solid rgba(191,149,63,0.7);
      color: rgba(42,10,11,0.85);
      padding: 7px 10px;
      cursor:pointer;
      font-family:'Cinzel';
      font-size:9px;
      letter-spacing: 1px;
      transition: .2s;
      border-radius: 10px;
      -webkit-tap-highlight-color: transparent;
    }
    .mini-btn:active{ transform: translateY(-1px); background: rgba(191,149,63,0.18); }

    /* --- ÿ∑ÿ®ŸÇÿ© ÿßŸÑŸÉÿ¥ŸÅ --- */
    .reveal-overlay {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top, rgba(111,29,27,0.98) 0%, rgba(42,10,11,0.98) 70%);
      z-index: 20;
      transform: translateY(100%);
      transition: transform 0.9s cubic-bezier(0.19, 1, 0.22, 1);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      text-align: center;
      border: 8px solid #bf953f;
      color: var(--paper-color);
    }
    .ticket-outer.opened .reveal-overlay { transform: translateY(0); }

    .panel{
      border: 1px solid rgba(191,149,63,0.92);
      padding: 24px 18px;
      width: 100%;
      background: rgba(0,0,0,0.14);
      backdrop-filter: blur(4px);
      max-width: 620px;
    }

    .msg-ar { font-size: 22px; line-height: 1.9; margin: 0 0 14px; font-weight: 700; }
    .msg-en { font-family: 'Playfair Display'; font-size: 14px; color: #fcf6ba; font-style: italic; margin: 0; opacity: 0.95; }

    .kpi{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin: 16px 0 14px;
      text-align: center;
    }
    .kpi .box{
      border: 1px solid rgba(242,230,208,0.22);
      padding: 10px 8px;
      background: rgba(255,255,255,0.06);
    }
    .kpi .label{
      font-family: 'Cinzel';
      letter-spacing: 2px;
      font-size: 9px;
      color: rgba(242,230,208,0.85);
    }
    .kpi .val{
      font-family: 'Cinzel';
      font-weight: 900;
      font-size: 16px;
      margin-top: 6px;
      color: #fcf6ba;
    }

    .reward{
      margin-top: 10px;
      border-top: 1px dashed rgba(242,230,208,0.25);
      padding-top: 12px;
      font-size: 14px;
      line-height: 1.9;
      color: rgba(242,230,208,0.98);
      white-space: pre-line;
    }
    .code{
      margin-top: 12px;
      font-family: 'Cinzel';
      letter-spacing: 3px;
      font-size: 12px;
      color: rgba(252,246,186,0.98);
      user-select: all;
      word-break: break-word;
    }

    .close-btn {
      margin-top: 16px;
      background: none;
      border: 1px solid #bf953f;
      color: #bf953f;
      padding: 10px 18px;
      cursor: pointer;
      font-family: 'Cinzel';
      font-size: 10px;
      transition: 0.25s;
      letter-spacing: 2px;
      border-radius: 12px;
      width: min(240px, 90%);
    }
    .close-btn:active { background: #bf953f; color: #120607; }

    /* ÿÆÿ™ŸÖ */
    .seal-gold {
      width: 82px;
      height: 82px;
      position: absolute;
      top: 50%;
      right: 15%;
      transform: translateY(-50%) rotate(-20deg);
      border-radius: 50%;
      background: var(--gold-foil);
      border: 2px solid #000;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Cinzel';
      font-weight: 900;
      box-shadow: 0 10px 20px rgba(0,0,0,0.3);
      opacity: 0.9;
      pointer-events: none;
      color:#120607;
    }

    /* ==========================================================
       MOBILE: ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ™ÿ∞ŸÉÿ±ÿ© ÿ•ŸÑŸâ Ÿàÿ∂ÿπ ÿπŸÖŸàÿØŸä Ÿàÿßÿ∂ÿ≠ + ÿ™ŸÉÿ®Ÿäÿ± ŸÉŸÑ ÿ¥Ÿäÿ°
       ========================================================== */
    @media (max-width: 720px){
      body{
        overflow: auto;
        perspective: none; /* ŸÖŸáŸÖ: 3D ÿπŸÑŸâ ÿßŸÑÿ¨ŸàÿßŸÑ ŸäÿÆÿ±Ÿëÿ® ÿßŸÑŸÇÿ±ÿßÿ°ÿ© */
      }

      #setup{
        padding: 28px 18px;
        border-radius: 14px;
      }
      .input-style{ font-size: 28px; }

      .ticket-outer{
        width: 100%;
        max-width: 440px;
        aspect-ratio: auto;
        transform: translateY(18px);
      }

      .ticket-body{
        flex-direction: column; /* ÿ£ŸáŸÖ ÿ™ÿ∫ŸäŸäÿ± */
        border-radius: 18px;
      }

      .ticket-body::before{
        border-width: 10px;
      }

      .ticket-stub{
        width: 100%;
        height: 54px;
        writing-mode: horizontal-tb;
        border-left: none;
        border-bottom: 3px dashed rgba(255,255,255,0.14);
        letter-spacing: 3px;
        font-size: 11px;
        padding: 0 10px;
      }

      .ticket-main{
        padding: 18px 16px 16px;
        gap: 12px;
      }

      .header-box h1{ font-size: 28px; }
      .header-box p{ font-size: 11px; letter-spacing: 4px; }

      .name-display{
        font-size: 56px; /* Ÿàÿßÿ∂ÿ≠ ÿπŸÑŸâ ÿßŸÑÿ¨ŸàÿßŸÑ */
        margin-top: 6px;
      }

      .meta-row{
        gap: 8px;
        margin-top: 10px;
      }
      .chip{
        font-size: 11px;
        padding: 9px 12px;
      }

      .stamp-track{
        max-width: 100%;
        gap: 8px;
        margin-top: 12px;
      }
      .dot{ width: 12px; height: 12px; }

      .footer-row{
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
        padding-top: 14px;
      }

      .barcode-section{
        display:flex;
        flex-direction: column;
        align-items: center;
        justify-content:center;
        background: rgba(191,149,63,0.12);
        border: 1px solid rgba(191,149,63,0.28);
      }

      .barcode-img{
        width: min(320px, 92%);
        height: 58px; /* ÿ£ŸÉÿ®ÿ± = ÿ£Ÿàÿ∂ÿ≠ */
      }

      .seal-gold{
        width: 64px;
        height: 64px;
        top: 12px;
        right: 12px;
        transform: rotate(-18deg);
      }

      .reveal-overlay{
        padding: 16px;
        border-width: 6px;
      }

      .panel{
        padding: 18px 14px;
      }

      .msg-ar{ font-size: 20px; }
      .kpi{ grid-template-columns: 1fr; }
      .close-btn{ font-size: 11px; }
    }
  </style>
</head>

<body>

  <!-- Setup -->
  <div id="setup" aria-hidden="true">
    <h2 class="gold-foil-text" style="font-size: 30px; margin:0;">LANO ROYAL ID</h2>
    <p style="color: rgba(242,230,208,0.78); letter-spacing: 2px; margin: 10px 0 0;">AUTHENTICATING YOUR ENTRY‚Ä¶</p>

    <input type="text" id="userName" class="input-style" placeholder="Your Name" maxlength="16">

    <div class="hint">
      ÿßŸÑŸÖÿ≥ ÿßŸÑÿ®ÿ∑ÿßŸÇÿ©‚Ä¶ ÿ´ŸÖ ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖŸÉ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸÅŸÇÿ∑. <br>
      ÿ®ÿπÿØ ÿ∞ŸÑŸÉÿå ÿ£Ÿä ŸÇÿ±ÿßÿ°ÿ© ŸÑŸÑŸÄNFC ÿ≥ÿ™ÿπÿ±ÿ∂ <b>ŸáŸàŸäÿ™ŸÉ</b> ŸÖÿ®ÿßÿ¥ÿ±ÿ©.
    </div>

    <div class="row-actions">
      <button class="btn" onclick="issueIdentity()">ÿ•ÿµÿØÿßÿ± ÿßŸÑŸáŸàŸäÿ©</button>
    </div>
  </div>

  <!-- Ticket -->
  <div class="ticket-outer" id="mainTicket" aria-live="polite">
    <div class="ticket-body">

      <div class="ticket-stub" id="stubText">
        ‚Ññ 7721-09-2026 ‚Ä¢ ADMIT ONE
      </div>

      <div class="ticket-main">
        <div class="header-box">
          <h1 class="gold-foil-text" id="headline">ROYAL MEMBER</h1>
          <p id="subhead">LANO WINTER EDITION</p>
        </div>

        <div class="center-content">
          <span>EXCLUSIVE ENTRY GRANTED TO</span>
          <div class="name-display" id="displayName">Guest</div>
          <div style="height: 1px; width: 120px; background: #bf953f; margin: 10px auto;"></div>

          <div class="meta-row">
            <div class="chip">VISITS: <b id="visitsChip">0</b></div>
            <div class="chip">STAMPS: <b id="stampsChip">0</b>/12</div>
            <div class="chip">TIER: <b id="tierChip">BRONZE</b></div>
          </div>

          <!-- 12 Visual Stamps -->
          <div class="stamp-track" id="stampTrack" aria-label="Stamps"></div>
        </div>

        <div class="footer-row">
          <div style="text-align: left; color: #3a2d2d; font-size: 11px; font-family: 'Cinzel'; min-width: 190px;">
            REF: <span id="refCode">LANO-ROYAL</span><br>
            STATUS: <span id="statusText">CONFIRMED</span>
            <div class="mini-actions" style="margin-top:8px;">
              <span style="opacity:.9;">Last:</span> <span id="lastSeen">‚Äî</span>
              <button class="mini-btn" onclick="editName()">ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿßÿ≥ŸÖ</button>
            </div>
          </div>

          <div class="barcode-section" onclick="openTicket()">
            <div class="barcode-img"></div>
            <div style="font-size: 9px; margin-top: 8px; color: var(--vintage-red); font-weight: bold; letter-spacing: 1px;">
              TAP TO REVEAL TODAY‚ÄôS ROYAL SEAL
            </div>
          </div>
        </div>

        <div class="seal-gold">L</div>
      </div>

      <!-- Reveal -->
      <div class="reveal-overlay" id="reveal">
        <div class="panel">
          <p class="msg-ar" id="arMsg">ÿ£ŸáŸÑÿßŸã ÿ®ŸÉ‚Ä¶</p>
          <p class="msg-en" id="enMsg">Welcome‚Ä¶</p>

          <div class="kpi">
            <div class="box">
              <div class="label">VISITS</div>
              <div class="val" id="kpiVisits">0</div>
            </div>
            <div class="box">
              <div class="label">STAMPS</div>
              <div class="val" id="kpiStamps">0/12</div>
            </div>
            <div class="box">
              <div class="label">TIER</div>
              <div class="val" id="kpiTier">BRONZE</div>
            </div>
          </div>

          <div class="reward" id="rewardBox" style="display:none;"></div>
          <div class="code" id="cashierCode" title="ÿßŸÜÿ≥ÿÆŸá ŸÑŸÑŸÉÿßÿ¥Ÿäÿ±"></div>

          <div style="font-family: 'Great Vibes'; font-size: 34px; color: #fcf6ba; margin-top: 14px;">LANO</div>

          <button class="close-btn" onclick="closeTicket()">ÿ•ÿ∫ŸÑÿßŸÇ</button>
        </div>
      </div>

    </div>
  </div>

<script>
  // =========================
  // LANO Royal Identity (LocalStorage)
  // =========================
  const STORAGE_KEY = "lano_royal_identity_v3";
  const VISIT_COOLDOWN_HOURS = 4;
  const NAME_CHANGE_COOLDOWN_DAYS = 30;
  const STAMP_CYCLE = 12;

  // ---- Visual stamps init
  const stampTrackEl = document.getElementById("stampTrack");
  function buildStampDots(){
    stampTrackEl.innerHTML = "";
    for(let i=0;i<STAMP_CYCLE;i++){
      const d = document.createElement("div");
      d.className = "dot";
      stampTrackEl.appendChild(d);
    }
  }
  buildStampDots();

  function fillStampDots(stamps){
    const dots = stampTrackEl.querySelectorAll(".dot");
    dots.forEach((el, idx) => {
      if(idx < stamps) el.classList.add("filled");
      else el.classList.remove("filled");
    });
  }

  function stageMessages(visits){
    if (visits <= 1) return {
      ar: "ŸÖÿ±ÿ≠ÿ®Ÿãÿß ÿ®ŸÉ ŸÅŸä LANO‚Ä¶ ÿßŸÑŸäŸàŸÖ ÿ®ÿØÿ£ÿ™ ŸáŸàŸäÿ™ŸÉ ÿßŸÑŸÖŸÑŸÉŸäÿ© ŸÖÿπŸÜÿß ‚ú®",
      en: "Welcome to LANO‚Ä¶ your royal identity begins today ‚ú®"
    };
    if (visits <= 3) return {
      ar: "ÿ±ÿ¨ÿπÿ™ŸÉ ŸÖŸà ÿπÿßÿØŸäÿ©‚Ä¶ ÿ£ŸÜÿ™ ŸÖŸÜ ÿßŸÑŸÜÿßÿ≥ ÿßŸÑŸÑŸä ŸÜÿ≠ÿ® ŸÜÿ¥ŸàŸÅŸáŸÖ ü§ç",
      en: "Your return isn‚Äôt ordinary‚Ä¶ we love seeing you here ü§ç"
    };
    if (visits <= 6) return {
      ar: "ÿ£ŸÜÿ™ ÿßŸÑÿ¢ŸÜ ŸÖŸÜ ÿßŸÑŸàÿ¨ŸàŸá ÿßŸÑŸÖÿ£ŸÑŸàŸÅÿ©‚Ä¶ ÿ£ŸáŸÑÿßŸã ÿ®ŸÉ ŸÅŸä ÿØÿßÿ¶ÿ±ÿ™ŸÜÿß ÿßŸÑÿÆÿßÿµÿ© üëë",
      en: "You‚Äôre becoming a familiar face‚Ä¶ welcome to our inner circle üëë"
    };
    if (visits <= 10) return {
      ar: "ŸàŸÑÿßÿ§ŸÉ Ÿàÿßÿ∂ÿ≠‚Ä¶ ŸàŸáÿ∞Ÿá ŸÑŸäÿ≥ÿ™ ÿµÿØŸÅÿ©ÿå Ÿáÿ∞Ÿá ÿπÿßÿØÿ© ÿ¨ŸÖŸäŸÑÿ© ‚ú®",
      en: "Your loyalty shows‚Ä¶ not luck, a beautiful habit ‚ú®"
    };
    return {
      ar: "ÿ£ŸÜÿ™ ŸÖŸÜ ÿ£ŸáŸÑ LANO‚Ä¶ ÿ™ÿ∞ŸÉÿ±ÿ™ŸÉ ŸÑŸÖ ÿ™ÿπÿØ ÿ™ÿ∞ŸÉÿ±ÿ©ÿå ÿµÿßÿ±ÿ™ ŸáŸàŸäÿ© üëë",
      en: "You belong to LANO‚Ä¶ this is no longer a ticket, it‚Äôs an identity üëë"
    };
  }

  function milestoneReward(visits){
    const map = {
      3:  { ar: "üéñÔ∏è ŸÖŸÉÿßŸÅÿ£ÿ©: ÿ•ÿ∂ÿßŸÅÿ© (ÿµŸàÿµ/ÿ™Ÿàÿ®ŸÜŸÇ) ŸÖÿ¨ÿßŸÜŸãÿß ÿßŸÑŸäŸàŸÖ.", en: "üéñÔ∏è Reward: a free add-on today." },
      6:  { ar: "üëë ŸÖŸÉÿßŸÅÿ£ÿ©: Upgrade ÿ≠ÿ¨ŸÖ/ÿ•ÿ∂ÿßŸÅÿ© ÿÆÿßÿµÿ© (ÿ≠ÿ≥ÿ® ÿßŸÑŸÖÿ™ÿßÿ≠).", en: "üëë Reward: an upgrade (subject to availability)." },
      9:  { ar: "‚ú® ŸÖŸÉÿßŸÅÿ£ÿ©: ÿ≠ŸÑŸàŸâ ÿµÿ∫Ÿäÿ±ÿ© ÿ£Ÿà ŸÖÿ¥ÿ±Ÿàÿ® ÿµÿ∫Ÿäÿ± (ÿ≠ÿ≥ÿ® ÿßŸÑŸÖÿ™ÿßÿ≠).", en: "‚ú® Reward: a small dessert/drink (subject to availability)." },
      12: { ar: "üèÜ ŸÖŸÉÿßŸÅÿ£ÿ©: ÿßŸÖÿ™Ÿäÿßÿ≤ ŸÖŸÑŸÉŸä ‚Äî ŸÖŸÉÿßŸÅÿ£ÿ© ÿÆÿßÿµÿ© + ÿ®ÿØÿ° ÿØŸàÿ±ÿ© ÿ£ÿÆÿ™ÿßŸÖ ÿ¨ÿØŸäÿØÿ©.", en: "üèÜ Reward: royal privilege ‚Äî special reward + new stamp cycle." }
    };
    return map[visits] || null;
  }

  function isLuckyWinner(){
    const h = new Date().getHours();
    const offPeak = (h < 16 || h >= 22);
    const p = offPeak ? 0.10 : 0.05;
    return Math.random() < p;
  }

  function luckyReward(){
    const rewards = [
      { ar: "üéâ LUCKY WINNER: ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ¨ÿßŸÜŸäÿ© ÿßŸÑŸäŸàŸÖ.", en: "üéâ LUCKY WINNER: a free add-on today." },
      { ar: "üéâ LUCKY WINNER: ÿÆÿµŸÖ 20% ÿπŸÑŸâ ŸÖŸÜÿ™ÿ¨ Ÿàÿßÿ≠ÿØ (ÿ∫Ÿäÿ± ŸÇÿßÿ®ŸÑ ŸÑŸÑÿ¨ŸÖÿπ).", en: "üéâ LUCKY WINNER: 20% off one item (not stackable)." },
      { ar: "üéâ LUCKY WINNER: ÿ≠ŸÑŸàŸâ ÿßŸÑŸäŸàŸÖ (ÿ≠ÿ≥ÿ® ÿßŸÑŸÖÿ™ÿßÿ≠).", en: "üéâ LUCKY WINNER: dessert of the day (subject to availability)." }
    ];
    return rewards[Math.floor(Math.random()*rewards.length)];
  }

  function tierFromVisits(v){
    if (v >= 12) return "DIAMOND";
    if (v >= 9)  return "GOLD";
    if (v >= 6)  return "SILVER";
    return "BRONZE";
  }

  function stampsFromVisits(v){
    const s = v % STAMP_CYCLE;
    return s === 0 && v > 0 ? STAMP_CYCLE : s;
  }

  function formatLastSeen(ts){
    if(!ts) return "‚Äî";
    const d = new Date(ts);
    return d.toLocaleString("ar-SA", { weekday: "short", day: "2-digit", month: "short", hour: "2-digit", minute:"2-digit" });
  }

  function randomId(len=10){
    const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let out = "";
    for(let i=0;i<len;i++) out += chars[Math.floor(Math.random()*chars.length)];
    return out;
  }

  function hashCode(str){
    let h = 0;
    for(let i=0;i<str.length;i++){
      h = (h<<5) - h + str.charCodeAt(i);
      h |= 0;
    }
    return Math.abs(h);
  }

  function makeCashierCode(profile){
    const now = new Date();
    const dayKey = `${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}`;
    const base = `${profile.id}|${profile.name}|${profile.visits}|${dayKey}`;
    const code = (hashCode(base).toString(36).toUpperCase()).slice(0,8);
    return `LANO-${code}`;
  }

  function loadProfile(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(!obj || !obj.id || !obj.name) return null;
      return obj;
    }catch(e){
      return null;
    }
  }

  function saveProfile(p){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(p));
  }

  function showSetup(){
    const setup = document.getElementById("setup");
    setup.style.display = "block";
    setup.setAttribute("aria-hidden", "false");
    document.getElementById("userName").focus();
  }

  function hideSetup(){
    const setup = document.getElementById("setup");
    setup.classList.add("fade-out");
    setup.setAttribute("aria-hidden", "true");
  }

  function activateTicket(){
    setTimeout(() => {
      document.getElementById("mainTicket").classList.add("active");
    }, 250);
  }

  function renderTicket(profile){
    document.getElementById("displayName").innerText = profile.name;
    document.getElementById("refCode").innerText = `LANO-${profile.id.slice(0,4)}${profile.id.slice(-2)}`;
    document.getElementById("statusText").innerText = "CONFIRMED";
    document.getElementById("lastSeen").innerText = formatLastSeen(profile.lastSeen);

    const tier = tierFromVisits(profile.visits);
    const stamps = stampsFromVisits(profile.visits);

    document.getElementById("visitsChip").innerText = profile.visits;
    document.getElementById("stampsChip").innerText = stamps;
    document.getElementById("tierChip").innerText = tier;

    fillStampDots(stamps);

    document.getElementById("stubText").innerText =
      `‚Ññ ${profile.id.slice(0,4)}-${String(profile.visits).padStart(2,"0")} ‚Ä¢ ADMIT ONE`;

    document.getElementById("headline").innerText = (tier === "DIAMOND") ? "ROYAL LEGEND" : "ROYAL MEMBER";
    document.getElementById("subhead").innerText = (tier === "DIAMOND") ? "EXCLUSIVE PRIVILEGE GRANTED" : "LANO WINTER EDITION";
  }

  function shouldCountVisit(profile){
    const now = Date.now();
    if(!profile.lastScanAt) return true;
    const diffMs = now - profile.lastScanAt;
    const diffHours = diffMs / (1000*60*60);
    return diffHours >= VISIT_COOLDOWN_HOURS;
  }

  function applyScan(profile){
    const now = Date.now();
    const counted = shouldCountVisit(profile);

    profile.lastSeen = now;

    if(counted){
      profile.visits = (profile.visits || 0) + 1;
      profile.lastScanAt = now;
      profile.totalScans = (profile.totalScans || 0) + 1;
      profile.lastVisitCountedAt = now;
    }else{
      profile.totalScans = (profile.totalScans || 0) + 1;
    }

    saveProfile(profile);
    return { counted };
  }

  function issueIdentity(){
    const name = (document.getElementById("userName").value || "").trim();
    if(!name){
      document.getElementById("userName").style.borderBottomColor = "#ffcf74";
      return;
    }

    const profile = {
      id: randomId(10),
      name,
      visits: 0,
      createdAt: Date.now(),
      lastSeen: null,
      lastScanAt: null,
      lastNameChangeAt: Date.now(),
      totalScans: 0
    };

    saveProfile(profile);
    hideSetup();
    renderTicket(profile);
    activateTicket();
  }

  function canChangeName(profile){
    if(!profile.lastNameChangeAt) return true;
    const diffMs = Date.now() - profile.lastNameChangeAt;
    const diffDays = diffMs / (1000*60*60*24);
    return diffDays >= 30;
  }

  function editName(){
    const p = loadProfile();
    if(!p) return;

    if(!canChangeName(p)){
      const remaining = Math.ceil(30 - ((Date.now() - p.lastNameChangeAt) / (1000*60*60*24)));
      alert(`ŸäŸÖŸÉŸÜŸÉ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿßÿ≥ŸÖ ÿ®ÿπÿØ ${remaining} ŸäŸàŸÖ/ÿ£ŸäÿßŸÖ.`);
      return;
    }

    const newName = prompt("ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖŸÉ:", p.name);
    if(newName && newName.trim()){
      p.name = newName.trim();
      p.lastNameChangeAt = Date.now();
      saveProfile(p);
      renderTicket(p);
    }
  }

  function openTicket(){
    const outer = document.getElementById("mainTicket");
    outer.classList.add("opened");

    const profile = loadProfile();
    if(!profile){
      outer.classList.remove("opened");
      showSetup();
      return;
    }

    const { counted } = applyScan(profile);
    renderTicket(profile);

    const tier = tierFromVisits(profile.visits);
    const stamps = stampsFromVisits(profile.visits);
    const stage = stageMessages(profile.visits);

    document.getElementById("arMsg").innerText = stage.ar;
    document.getElementById("enMsg").innerText = stage.en;

    document.getElementById("kpiVisits").innerText = profile.visits;
    document.getElementById("kpiStamps").innerText = `${stamps}/${12}`;
    document.getElementById("kpiTier").innerText = tier;

    const rewardBox = document.getElementById("rewardBox");
    rewardBox.style.display = "none";
    rewardBox.innerText = "";

    let reward = milestoneReward(profile.visits);
    if(!reward && isLuckyWinner()){
      reward = luckyReward();
    }
    if(reward){
      rewardBox.style.display = "block";
      rewardBox.innerText = reward.ar + "\n" + reward.en;
    }

    document.getElementById("cashierCode").innerText = `CODE: ${makeCashierCode(profile)}`;
  }

  function closeTicket(){
    document.getElementById("mainTicket").classList.remove("opened");
  }

  (function init(){
    const profile = loadProfile();
    if(profile){
      document.getElementById("setup").style.display = "none";
      renderTicket(profile);
      activateTicket();
    }else{
      showSetup();
    }
  })();
</script>

</body>
</html>

