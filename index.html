<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LANO | Royal Identity</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Cinzel:wght@400;700;900&family=Great+Vibes&family=Playfair+Display:ital,wght@0,900;1,900&display=swap" rel="stylesheet">

  <style>
    :root {
      --gold-foil: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
      --lano-burgundy: #6f1d1b;        /* Ø£Ø­Ù…Ø± ØºØ§Ù…Ù‚ */
      --lano-burgundy-2: #3b0f10;      /* Ø£ØºÙ…Ù‚ Ù„Ù„Ø®Ù„ÙÙŠØ§Øª */
      --paper-color: #f2e6d0;          /* Ø¨ÙŠØ¬ */
      --vintage-red: #8b1f24;          /* Ø®Ø·ÙˆØ·/ØªÙØ§ØµÙŠÙ„ */
      --ink: #1b1b1b;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at center, #2a0a0b 0%, #070102 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: "Amiri", serif;
      overflow: hidden;
      perspective: 1000px;
      color: var(--paper-color);
    }

    /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¥ØµØ¯Ø§Ø± */
    #setup {
      position: absolute;
      z-index: 100;
      text-align: center;
      background: rgba(59, 15, 16, 0.92);
      padding: 44px 46px;
      border: 1px solid #bf953f;
      border-radius: 2px;
      box-shadow: 0 0 100px rgba(0,0,0,0.8);
      transition: 0.8s;
      width: min(540px, calc(100% - 28px));
      backdrop-filter: blur(6px);
    }
    .fade-out { opacity: 0; pointer-events: none; transform: scale(1.05); }

    .gold-foil-text {
      background: var(--gold-foil);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-family: 'Cinzel';
      font-weight: 900;
      letter-spacing: 3px;
    }

    .input-style {
      background: none;
      border: none;
      border-bottom: 2px solid #bf953f;
      color: #f2e6d0;
      font-size: 30px;
      font-family: 'Great Vibes', cursive;
      text-align: center;
      margin: 22px 0 10px;
      width: min(360px, 85%);
      outline: none;
    }

    .hint {
      margin-top: 10px;
      font-size: 13px;
      color: rgba(242,230,208,0.78);
      letter-spacing: 0.4px;
      line-height: 1.8;
    }

    .row-actions{
      margin-top: 18px;
      display:flex;
      gap:12px;
      justify-content:center;
      flex-wrap:wrap;
    }

    .btn {
      background: none;
      border: 1px solid #bf953f;
      color: #bf953f;
      padding: 12px 34px;
      cursor: pointer;
      font-family: 'Cinzel';
      font-size: 12px;
      transition: 0.25s;
      letter-spacing: 2px;
    }
    .btn:hover { background: #bf953f; color: #120607; transform: translateY(-1px); }

    /* --- Ø§Ù„ØªØ°ÙƒØ±Ø© --- */
    .ticket-outer {
      width: 90%;
      max-width: 880px;
      aspect-ratio: 2.1 / 1;
      position: relative;
      opacity: 0;
      transform: rotateY(20deg) rotateX(10deg) translateY(50px);
      transition: all 1.2s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .ticket-outer.active { opacity: 1; transform: rotateY(0) rotateX(0) translateY(0); }

    .ticket-body {
      width: 100%;
      height: 100%;
      background-color: var(--paper-color);
      background-image: url("https://www.transparenttextures.com/patterns/cream-paper.png");
      border-radius: 10px;
      box-shadow: 0 40px 80px rgba(0,0,0,0.7);
      display: flex;
      position: relative;
      overflow: hidden;
      filter: drop-shadow(0 0 1px rgba(0,0,0,0.2));
      color: var(--ink);
    }

    .ticket-body::before {
      content: "";
      position: absolute;
      inset: 0;
      border: 12px solid transparent;
      border-image: repeating-linear-gradient(
        45deg,
        var(--vintage-red) 0, var(--vintage-red) 15px,
        var(--paper-color) 15px, var(--paper-color) 25px,
        #2a0a0b 25px, #2a0a0b 40px
      ) 40;
      z-index: 5;
      pointer-events: none;
    }

    .ticket-stub {
      width: 110px;
      background: linear-gradient(180deg, var(--lano-burgundy) 0%, #2a0a0b 100%);
      color: var(--paper-color);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Cinzel';
      font-size: 12px;
      letter-spacing: 4px;
      writing-mode: vertical-lr;
      border-left: 3px dashed rgba(255,255,255,0.12);
      z-index: 6;
      text-align:center;
      padding: 10px 0;
    }

    .ticket-main {
      flex: 1;
      padding: 28px 40px;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      z-index: 4;
    }

    .header-box { text-align: center; }
    .header-box h1 { font-size: 38px; margin: 0; }
    .header-box p {
      color: var(--vintage-red);
      font-size: 13px;
      font-weight: bold;
      letter-spacing: 5px;
      margin-top: 6px;
      text-transform: uppercase;
    }

    .center-content { text-align: center; }
    .center-content span { font-family: 'Cinzel'; font-size: 10px; color: #2a0a0b; opacity: 0.65; }
    .name-display {
      font-family: 'Great Vibes', cursive;
      font-size: 64px;
      color: #2a0a0b;
      margin: 4px 0 2px;
      filter: drop-shadow(1px 1px 0px white);
    }

    .meta-row{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top: 6px;
    }
    .chip{
      border:1px solid rgba(42,10,11,0.18);
      background: rgba(255,255,255,0.55);
      padding: 6px 10px;
      border-radius: 999px;
      font-family: 'Cinzel';
      font-size: 10px;
      letter-spacing: 1px;
      color: rgba(42,10,11,0.85);
    }
    .chip b{ color: #2a0a0b; }

    /* Ø®ØªÙ… Ø¨ØµØ±ÙŠ */
    .stamp-track{
      margin-top: 10px;
      display:flex;
      gap:7px;
      justify-content:center;
      flex-wrap:wrap;
      max-width: 420px;
      padding: 0 8px;
    }
    .dot{
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 1px solid rgba(42,10,11,0.28);
      background: rgba(255,255,255,0.45);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.4);
    }
    .dot.filled{
      background: linear-gradient(135deg, rgba(191,149,63,0.95), rgba(252,246,186,0.95));
      border-color: rgba(0,0,0,0.25);
    }

    .footer-row {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      border-top: 1px solid rgba(0,0,0,0.12);
      padding-top: 18px;
      gap: 16px;
    }

    .barcode-section {
      text-align: center;
      cursor: pointer;
      padding: 8px 10px;
      transition: 0.25s;
      user-select: none;
    }
    .barcode-section:hover { transform: translateY(-4px); }

    .barcode-img {
      width: 190px;
      height: 46px;
      background: #000;
      mask: repeating-linear-gradient(90deg, #000 0, #000 2px, transparent 2px, transparent 6px);
      -webkit-mask: repeating-linear-gradient(90deg, #000 0, #000 2px, transparent 2px, transparent 6px);
      border-radius: 2px;
    }

    .mini-actions{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-start;
      flex-wrap:wrap;
      font-family: 'Cinzel';
      font-size: 10px;
      letter-spacing: 1px;
      color: rgba(0,0,0,0.55);
    }

    .mini-btn{
      background:none;
      border: 1px solid rgba(191,149,63,0.7);
      color: rgba(42,10,11,0.85);
      padding: 6px 10px;
      cursor:pointer;
      font-family:'Cinzel';
      font-size:9px;
      letter-spacing: 1px;
      transition: .2s;
    }
    .mini-btn:hover{ background: rgba(191,149,63,0.18); transform: translateY(-1px); }

    /* --- Ø·Ø¨Ù‚Ø© Ø§Ù„ÙƒØ´Ù --- */
    .reveal-overlay {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top, rgba(111,29,27,0.98) 0%, rgba(42,10,11,0.98) 70%);
      z-index: 20;
      transform: translateY(100%);
      transition: transform 0.9s cubic-bezier(0.19, 1, 0.22, 1);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 34px;
      text-align: center;
      border: 8px solid #bf953f;
      color: var(--paper-color);
    }
    .ticket-outer.opened .reveal-overlay { transform: translateY(0); }

    .panel{
      border: 1px solid rgba(191,149,63,0.92);
      padding: 26px 24px;
      width: 100%;
      background: rgba(0,0,0,0.14);
      backdrop-filter: blur(4px);
    }

    .msg-ar { font-size: 22px; line-height: 1.9; margin: 0 0 14px; font-weight: 700; }
    .msg-en { font-family: 'Playfair Display'; font-size: 14px; color: #fcf6ba; font-style: italic; margin: 0; opacity: 0.95; }

    .kpi{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin: 16px 0 14px;
      text-align: center;
    }
    .kpi .box{
      border: 1px solid rgba(242,230,208,0.22);
      padding: 10px 8px;
      background: rgba(255,255,255,0.06);
    }
    .kpi .label{
      font-family: 'Cinzel';
      letter-spacing: 2px;
      font-size: 9px;
      color: rgba(242,230,208,0.85);
    }
    .kpi .val{
      font-family: 'Cinzel';
      font-weight: 900;
      font-size: 16px;
      margin-top: 6px;
      color: #fcf6ba;
    }

    .reward{
      margin-top: 10px;
      border-top: 1px dashed rgba(242,230,208,0.25);
      padding-top: 12px;
      font-size: 14px;
      line-height: 1.9;
      color: rgba(242,230,208,0.98);
      white-space: pre-line;
    }
    .code{
      margin-top: 12px;
      font-family: 'Cinzel';
      letter-spacing: 3px;
      font-size: 12px;
      color: rgba(252,246,186,0.98);
      user-select: all;
    }

    .close-btn {
      margin-top: 16px;
      background: none;
      border: 1px solid #bf953f;
      color: #bf953f;
      padding: 9px 18px;
      cursor: pointer;
      font-family: 'Cinzel';
      font-size: 10px;
      transition: 0.25s;
      letter-spacing: 2px;
    }
    .close-btn:hover { background: #bf953f; color: #120607; }

    /* Ø®ØªÙ… */
    .seal-gold {
      width: 82px;
      height: 82px;
      position: absolute;
      top: 50%;
      right: 15%;
      transform: translateY(-50%) rotate(-20deg);
      border-radius: 50%;
      background: var(--gold-foil);
      border: 2px solid #000;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Cinzel';
      font-weight: 900;
      box-shadow: 0 10px 20px rgba(0,0,0,0.3);
      opacity: 0.9;
      pointer-events: none;
      color:#120607;
    }

    @media (max-width: 720px){
      .ticket-main{ padding: 20px 18px; }
      .name-display{ font-size: 52px; }
      .header-box h1{ font-size: 30px; }
      .ticket-stub{ width: 92px; font-size: 11px; }
      .barcode-img{ width: 170px; }
      .kpi{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <!-- Setup -->
  <div id="setup" aria-hidden="true">
    <h2 class="gold-foil-text" style="font-size: 30px; margin:0;">LANO ROYAL ID</h2>
    <p style="color: rgba(242,230,208,0.78); letter-spacing: 2px; margin: 10px 0 0;">AUTHENTICATING YOUR ENTRYâ€¦</p>

    <input type="text" id="userName" class="input-style" placeholder="Your Name" maxlength="16">

    <div class="hint">
      Ø§Ù„Ù…Ø³ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©â€¦ Ø«Ù… Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·. <br>
      Ø¨Ø¹Ø¯ Ø°Ù„ÙƒØŒ Ø£ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù„Ù„Ù€NFC Ø³ØªØ¹Ø±Ø¶ <b>Ù‡ÙˆÙŠØªÙƒ</b> Ù…Ø¨Ø§Ø´Ø±Ø©.
    </div>

    <div class="row-actions">
      <button class="btn" onclick="issueIdentity()">Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù‡ÙˆÙŠØ©</button>
    </div>
  </div>

  <!-- Ticket -->
  <div class="ticket-outer" id="mainTicket" aria-live="polite">
    <div class="ticket-body">

      <div class="ticket-stub" id="stubText">
        â„– 7721-09-2026 â€¢ ADMIT ONE
      </div>

      <div class="ticket-main">
        <div class="header-box">
          <h1 class="gold-foil-text" id="headline">ROYAL MEMBER</h1>
          <p id="subhead">LANO WINTER EDITION</p>
        </div>

        <div class="center-content">
          <span>EXCLUSIVE ENTRY GRANTED TO</span>
          <div class="name-display" id="displayName">Guest</div>
          <div style="height: 1px; width: 120px; background: #bf953f; margin: 10px auto;"></div>

          <div class="meta-row">
            <div class="chip">VISITS: <b id="visitsChip">0</b></div>
            <div class="chip">STAMPS: <b id="stampsChip">0</b>/12</div>
            <div class="chip">TIER: <b id="tierChip">BRONZE</b></div>
          </div>

          <!-- 12 Visual Stamps -->
          <div class="stamp-track" id="stampTrack" aria-label="Stamps"></div>
        </div>

        <div class="footer-row">
          <div style="text-align: left; color: #3a2d2d; font-size: 11px; font-family: 'Cinzel'; min-width: 190px;">
            REF: <span id="refCode">LANO-ROYAL</span><br>
            STATUS: <span id="statusText">CONFIRMED</span>
            <div class="mini-actions" style="margin-top:8px;">
              <span style="opacity:.9;">Last:</span> <span id="lastSeen">â€”</span>
              <button class="mini-btn" onclick="editName()">ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…</button>
            </div>
          </div>

          <div class="barcode-section" onclick="openTicket()">
            <div class="barcode-img"></div>
            <div style="font-size: 9px; margin-top: 6px; color: var(--vintage-red); font-weight: bold; letter-spacing: 1px;">
              TAP TO REVEAL TODAYâ€™S ROYAL SEAL
            </div>
          </div>
        </div>

        <div class="seal-gold">L</div>
      </div>

      <!-- Reveal -->
      <div class="reveal-overlay" id="reveal">
        <div class="panel">
          <p class="msg-ar" id="arMsg">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒâ€¦</p>
          <p class="msg-en" id="enMsg">Welcomeâ€¦</p>

          <div class="kpi">
            <div class="box">
              <div class="label">VISITS</div>
              <div class="val" id="kpiVisits">0</div>
            </div>
            <div class="box">
              <div class="label">STAMPS</div>
              <div class="val" id="kpiStamps">0/12</div>
            </div>
            <div class="box">
              <div class="label">TIER</div>
              <div class="val" id="kpiTier">BRONZE</div>
            </div>
          </div>

          <div class="reward" id="rewardBox" style="display:none;"></div>
          <div class="code" id="cashierCode" title="Ø§Ù†Ø³Ø®Ù‡ Ù„Ù„ÙƒØ§Ø´ÙŠØ±"></div>

          <div style="font-family: 'Great Vibes'; font-size: 34px; color: #fcf6ba; margin-top: 14px;">LANO</div>

          <button class="close-btn" onclick="closeTicket()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>

    </div>
  </div>

<script>
  // =========================
  // LANO Royal Identity (LocalStorage)
  // =========================
  const STORAGE_KEY = "lano_royal_identity_v3"; // Ù†Ø³Ø®Ø© Ø¬Ø¯ÙŠØ¯Ø©
  const VISIT_COOLDOWN_HOURS = 4;               // Ù„Ø§ ÙŠØ²ÙŠØ¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ 4 Ø³Ø§Ø¹Ø§Øª
  const NAME_CHANGE_COOLDOWN_DAYS = 30;         // ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… Ù…Ø±Ø© ÙƒÙ„ 30 ÙŠÙˆÙ… (ØªØ·ÙˆÙŠØ±)
  const STAMP_CYCLE = 12;

  // ---- Visual stamps init
  const stampTrackEl = document.getElementById("stampTrack");
  function buildStampDots(){
    stampTrackEl.innerHTML = "";
    for(let i=0;i<STAMP_CYCLE;i++){
      const d = document.createElement("div");
      d.className = "dot";
      stampTrackEl.appendChild(d);
    }
  }
  buildStampDots();

  function fillStampDots(stamps){
    const dots = stampTrackEl.querySelectorAll(".dot");
    dots.forEach((el, idx) => {
      if(idx < stamps) el.classList.add("filled");
      else el.classList.remove("filled");
    });
  }

  // Ø±Ø³Ø§Ø¦Ù„ Ø­Ø³Ø¨ Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø²ÙŠØ§Ø±Ø©
  function stageMessages(visits){
    if (visits <= 1) return {
      ar: "Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ LANOâ€¦ Ø§Ù„ÙŠÙˆÙ… Ø¨Ø¯Ø£Øª Ù‡ÙˆÙŠØªÙƒ Ø§Ù„Ù…Ù„ÙƒÙŠØ© Ù…Ø¹Ù†Ø§ âœ¨",
      en: "Welcome to LANOâ€¦ your royal identity begins today âœ¨"
    };
    if (visits <= 3) return {
      ar: "Ø±Ø¬Ø¹ØªÙƒ Ù…Ùˆ Ø¹Ø§Ø¯ÙŠØ©â€¦ Ø£Ù†Øª Ù…Ù† Ø§Ù„Ù†Ø§Ø³ Ø§Ù„Ù„ÙŠ Ù†Ø­Ø¨ Ù†Ø´ÙˆÙÙ‡Ù… ğŸ¤",
      en: "Your return isnâ€™t ordinaryâ€¦ we love seeing you here ğŸ¤"
    };
    if (visits <= 6) return {
      ar: "Ø£Ù†Øª Ø§Ù„Ø¢Ù† Ù…Ù† Ø§Ù„ÙˆØ¬ÙˆÙ‡ Ø§Ù„Ù…Ø£Ù„ÙˆÙØ©â€¦ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¯Ø§Ø¦Ø±ØªÙ†Ø§ Ø§Ù„Ø®Ø§ØµØ© ğŸ‘‘",
      en: "Youâ€™re becoming a familiar faceâ€¦ welcome to our inner circle ğŸ‘‘"
    };
    if (visits <= 10) return {
      ar: "ÙˆÙ„Ø§Ø¤Ùƒ ÙˆØ§Ø¶Ø­â€¦ ÙˆÙ‡Ø°Ù‡ Ù„ÙŠØ³Øª ØµØ¯ÙØ©ØŒ Ù‡Ø°Ù‡ Ø¹Ø§Ø¯Ø© Ø¬Ù…ÙŠÙ„Ø© âœ¨",
      en: "Your loyalty showsâ€¦ not luck, a beautiful habit âœ¨"
    };
    return {
      ar: "Ø£Ù†Øª Ù…Ù† Ø£Ù‡Ù„ LANOâ€¦ ØªØ°ÙƒØ±ØªÙƒ Ù„Ù… ØªØ¹Ø¯ ØªØ°ÙƒØ±Ø©ØŒ ØµØ§Ø±Øª Ù‡ÙˆÙŠØ© ğŸ‘‘",
      en: "You belong to LANOâ€¦ this is no longer a ticket, itâ€™s an identity ğŸ‘‘"
    };
  }

  // Ù…ÙƒØ§ÙØ¢Øª Ø¹Ù„Ù‰ Ù…Ø­Ø·Ø§Øª (Ø¹Ø¯Ù‘Ù„Ù‡Ø§ Ø­Ø³Ø¨ Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­)
  function milestoneReward(visits){
    const map = {
      3:  { ar: "ğŸ–ï¸ Ù…ÙƒØ§ÙØ£Ø©: Ø¥Ø¶Ø§ÙØ© (ØµÙˆØµ/ØªÙˆØ¨Ù†Ù‚) Ù…Ø¬Ø§Ù†Ù‹Ø§ Ø§Ù„ÙŠÙˆÙ….", en: "ğŸ–ï¸ Reward: a free add-on today." },
      6:  { ar: "ğŸ‘‘ Ù…ÙƒØ§ÙØ£Ø©: Upgrade Ø­Ø¬Ù…/Ø¥Ø¶Ø§ÙØ© Ø®Ø§ØµØ© (Ø­Ø³Ø¨ Ø§Ù„Ù…ØªØ§Ø­).", en: "ğŸ‘‘ Reward: an upgrade (subject to availability)." },
      9:  { ar: "âœ¨ Ù…ÙƒØ§ÙØ£Ø©: Ø­Ù„ÙˆÙ‰ ØµØºÙŠØ±Ø© Ø£Ùˆ Ù…Ø´Ø±ÙˆØ¨ ØµØºÙŠØ± (Ø­Ø³Ø¨ Ø§Ù„Ù…ØªØ§Ø­).", en: "âœ¨ Reward: a small dessert/drink (subject to availability)." },
      12: { ar: "ğŸ† Ù…ÙƒØ§ÙØ£Ø©: Ø§Ù…ØªÙŠØ§Ø² Ù…Ù„ÙƒÙŠ â€” Ù…ÙƒØ§ÙØ£Ø© Ø®Ø§ØµØ© + Ø¨Ø¯Ø¡ Ø¯ÙˆØ±Ø© Ø£Ø®ØªØ§Ù… Ø¬Ø¯ÙŠØ¯Ø©.", en: "ğŸ† Reward: royal privilege â€” special reward + new stamp cycle." }
    };
    return map[visits] || null;
  }

  // Lucky Winner probability
  function isLuckyWinner(){
    const h = new Date().getHours();
    const offPeak = (h < 16 || h >= 22);
    const p = offPeak ? 0.10 : 0.05;
    return Math.random() < p;
  }

  function luckyReward(){
    const rewards = [
      { ar: "ğŸ‰ LUCKY WINNER: Ø¥Ø¶Ø§ÙØ© Ù…Ø¬Ø§Ù†ÙŠØ© Ø§Ù„ÙŠÙˆÙ….", en: "ğŸ‰ LUCKY WINNER: a free add-on today." },
      { ar: "ğŸ‰ LUCKY WINNER: Ø®ØµÙ… 20% Ø¹Ù„Ù‰ Ù…Ù†ØªØ¬ ÙˆØ§Ø­Ø¯ (ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø¬Ù…Ø¹).", en: "ğŸ‰ LUCKY WINNER: 20% off one item (not stackable)." },
      { ar: "ğŸ‰ LUCKY WINNER: Ø­Ù„ÙˆÙ‰ Ø§Ù„ÙŠÙˆÙ… (Ø­Ø³Ø¨ Ø§Ù„Ù…ØªØ§Ø­).", en: "ğŸ‰ LUCKY WINNER: dessert of the day (subject to availability)." }
    ];
    return rewards[Math.floor(Math.random()*rewards.length)];
  }

  function tierFromVisits(v){
    if (v >= 12) return "DIAMOND";
    if (v >= 9)  return "GOLD";
    if (v >= 6)  return "SILVER";
    return "BRONZE";
  }

  function stampsFromVisits(v){
    const s = v % STAMP_CYCLE;
    return s === 0 && v > 0 ? STAMP_CYCLE : s;
  }

  function formatLastSeen(ts){
    if(!ts) return "â€”";
    const d = new Date(ts);
    return d.toLocaleString("ar-SA", { weekday: "short", day: "2-digit", month: "short", hour: "2-digit", minute:"2-digit" });
  }

  function randomId(len=10){
    const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let out = "";
    for(let i=0;i<len;i++) out += chars[Math.floor(Math.random()*chars.length)];
    return out;
  }

  function hashCode(str){
    let h = 0;
    for(let i=0;i<str.length;i++){
      h = (h<<5) - h + str.charCodeAt(i);
      h |= 0;
    }
    return Math.abs(h);
  }

  // ÙƒÙˆØ¯ ÙƒØ§Ø´ÙŠØ± Ø«Ø§Ø¨Øª ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…
  function makeCashierCode(profile){
    const now = new Date();
    const dayKey = `${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}`;
    const base = `${profile.id}|${profile.name}|${profile.visits}|${dayKey}`;
    const code = (hashCode(base).toString(36).toUpperCase()).slice(0,8);
    return `LANO-${code}`;
  }

  function loadProfile(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(!obj || !obj.id || !obj.name) return null;
      return obj;
    }catch(e){
      return null;
    }
  }

  function saveProfile(p){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(p));
  }

  function showSetup(){
    const setup = document.getElementById("setup");
    setup.style.display = "block";
    setup.setAttribute("aria-hidden", "false");
    document.getElementById("userName").focus();
  }

  function hideSetup(){
    const setup = document.getElementById("setup");
    setup.classList.add("fade-out");
    setup.setAttribute("aria-hidden", "true");
  }

  function activateTicket(){
    setTimeout(() => {
      document.getElementById("mainTicket").classList.add("active");
    }, 350);
  }

  function renderTicket(profile){
    document.getElementById("displayName").innerText = profile.name;
    document.getElementById("refCode").innerText = `LANO-${profile.id.slice(0,4)}${profile.id.slice(-2)}`;
    document.getElementById("statusText").innerText = "CONFIRMED";
    document.getElementById("lastSeen").innerText = formatLastSeen(profile.lastSeen);

    const tier = tierFromVisits(profile.visits);
    const stamps = stampsFromVisits(profile.visits);

    document.getElementById("visitsChip").innerText = profile.visits;
    document.getElementById("stampsChip").innerText = stamps;
    document.getElementById("tierChip").innerText = tier;

    fillStampDots(stamps);

    document.getElementById("stubText").innerText =
      `â„– ${profile.id.slice(0,4)}-${String(profile.visits).padStart(2,"0")} â€¢ ADMIT ONE`;

    document.getElementById("headline").innerText = (tier === "DIAMOND") ? "ROYAL LEGEND" : "ROYAL MEMBER";
    document.getElementById("subhead").innerText = (tier === "DIAMOND") ? "EXCLUSIVE PRIVILEGE GRANTED" : "LANO WINTER EDITION";
  }

  function shouldCountVisit(profile){
    const now = Date.now();
    if(!profile.lastScanAt) return true;
    const diffMs = now - profile.lastScanAt;
    const diffHours = diffMs / (1000*60*60);
    return diffHours >= VISIT_COOLDOWN_HOURS;
  }

  function applyScan(profile){
    const now = Date.now();
    const counted = shouldCountVisit(profile);

    profile.lastSeen = now;

    if(counted){
      profile.visits = (profile.visits || 0) + 1;
      profile.lastScanAt = now;
      profile.totalScans = (profile.totalScans || 0) + 1;
      profile.lastVisitCountedAt = now;
    }else{
      profile.totalScans = (profile.totalScans || 0) + 1;
    }

    saveProfile(profile);
    return { counted };
  }

  // ========= Actions =========
  function issueIdentity(){
    const name = (document.getElementById("userName").value || "").trim();
    if(!name){
      document.getElementById("userName").style.borderBottomColor = "#ffcf74";
      return;
    }

    const profile = {
      id: randomId(10),
      name,
      visits: 0,
      createdAt: Date.now(),
      lastSeen: null,
      lastScanAt: null,
      lastNameChangeAt: Date.now(),
      totalScans: 0
    };

    saveProfile(profile);
    hideSetup();
    renderTicket(profile);
    activateTicket();
  }

  function canChangeName(profile){
    if(!profile.lastNameChangeAt) return true;
    const diffMs = Date.now() - profile.lastNameChangeAt;
    const diffDays = diffMs / (1000*60*60*24);
    return diffDays >= NAME_CHANGE_COOLDOWN_DAYS;
  }

  function editName(){
    const p = loadProfile();
    if(!p) return;

    if(!canChangeName(p)){
      const remaining = Math.ceil(NAME_CHANGE_COOLDOWN_DAYS - ((Date.now() - p.lastNameChangeAt) / (1000*60*60*24)));
      alert(`ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… Ø¨Ø¹Ø¯ ${remaining} ÙŠÙˆÙ…/Ø£ÙŠØ§Ù….`);
      return;
    }

    const newName = prompt("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ:", p.name);
    if(newName && newName.trim()){
      p.name = newName.trim();
      p.lastNameChangeAt = Date.now();
      saveProfile(p);
      renderTicket(p);
    }
  }

  function openTicket(){
    const outer = document.getElementById("mainTicket");
    outer.classList.add("opened");

    const profile = loadProfile();
    if(!profile){
      outer.classList.remove("opened");
      showSetup();
      return;
    }

    const { counted } = applyScan(profile);
    renderTicket(profile);

    const tier = tierFromVisits(profile.visits);
    const stamps = stampsFromVisits(profile.visits);
    const stage = stageMessages(profile.visits);

    document.getElementById("arMsg").innerText = stage.ar;
    document.getElementById("enMsg").innerText = stage.en;

    document.getElementById("kpiVisits").innerText = profile.visits;
    document.getElementById("kpiStamps").innerText = `${stamps}/${STAMP_CYCLE}`;
    document.getElementById("kpiTier").innerText = tier;

    const rewardBox = document.getElementById("rewardBox");
    rewardBox.style.display = "none";
    rewardBox.innerText = "";

    let reward = milestoneReward(profile.visits);
    if(!reward && isLuckyWinner()){
      reward = luckyReward();
    }
    if(reward){
      rewardBox.style.display = "block";
      rewardBox.innerText = reward.ar + "\n" + reward.en;
    }

    // Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø³ÙŠØ· Ø¯Ø§Ø®Ù„ÙŠ Ø¶Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· ÙƒØ±Ø³Ø§Ù„Ø© ØªØ­Øª Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ù„Ùˆ ØªØ­Ø¨)
    if(!counted){
      // Ù…Ø§ Ù†Ø¶ÙŠÙ Ø¹Ù†ØµØ± Ø¬Ø¯ÙŠØ¯ Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© Ø­ÙØ§Ø¸Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙØ®Ø§Ù…Ø©ØŒ Ù„ÙƒÙ† Ù†Ù‚Ø¯Ø± Ù†Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡ Ø®ÙÙŠÙ:
      // rewardBox.style.display = "block";
      // rewardBox.innerText = "â³ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±ÙƒØŒ ÙˆØ³ØªÙØ­ØªØ³Ø¨ Ø²ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø¹Ø¯ ÙØªØ±Ø©.\nYour scan is recorded. A new visit will count later.";
    }

    document.getElementById("cashierCode").innerText = `CODE: ${makeCashierCode(profile)}`;
  }

  function closeTicket(){
    document.getElementById("mainTicket").classList.remove("opened");
  }

  // ========= Boot =========
  (function init(){
    const profile = loadProfile();
    if(profile){
      document.getElementById("setup").style.display = "none";
      renderTicket(profile);
      activateTicket();
    }else{
      showSetup();
    }
  })();
</script>

</body>
</html>
