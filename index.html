<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LANO | The Royal Ticket</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Cinzel:wght@400;700;900&family=Great+Vibes&family=Playfair+Display:ital,wght@0,900;1,900&display=swap" rel="stylesheet">

  <style>
    :root {
      --gold-foil: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
      --royal-green: #0d261d;
      --paper-color: #f2e6d0;
      --vintage-red: #962828;
      --ink: #1b1b1b;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at center, #1a3a2f 0%, #050a08 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: "Amiri", serif;
      overflow: hidden;
      perspective: 1000px;
      color: var(--paper-color);
    }

    /* ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿØÿÆŸàŸÑ */
    #setup {
      position: absolute;
      z-index: 100;
      text-align: center;
      background: rgba(13, 38, 29, 0.92);
      padding: 40px 45px;
      border: 1px solid #bf953f;
      border-radius: 2px;
      box-shadow: 0 0 100px rgba(0,0,0,0.8);
      transition: 0.8s;
      width: min(520px, calc(100% - 28px));
    }
    .fade-out { opacity: 0; pointer-events: none; transform: scale(1.05); }

    .input-style {
      background: none;
      border: none;
      border-bottom: 2px solid #bf953f;
      color: #f2e6d0;
      font-size: 28px;
      font-family: 'Great Vibes', cursive;
      text-align: center;
      margin: 22px 0 10px;
      width: min(340px, 85%);
      outline: none;
    }

    .hint {
      margin-top: 8px;
      font-size: 13px;
      color: rgba(242,230,208,0.7);
      letter-spacing: 0.5px;
      line-height: 1.7;
    }

    .row-actions{
      margin-top: 18px;
      display:flex;
      gap:12px;
      justify-content:center;
      flex-wrap:wrap;
    }

    /* --- ÿßŸÑÿ™ÿ∞ŸÉÿ±ÿ© --- */
    .ticket-outer {
      width: 90%;
      max-width: 850px;
      aspect-ratio: 2.1 / 1;
      position: relative;
      opacity: 0;
      transform: rotateY(20deg) rotateX(10deg) translateY(50px);
      transition: all 1.2s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .ticket-outer.active { opacity: 1; transform: rotateY(0) rotateX(0) translateY(0); }

    .ticket-body {
      width: 100%;
      height: 100%;
      background-color: var(--paper-color);
      background-image: url("https://www.transparenttextures.com/patterns/cream-paper.png");
      border-radius: 8px;
      box-shadow: 0 40px 80px rgba(0,0,0,0.7);
      display: flex;
      position: relative;
      overflow: hidden;
      filter: drop-shadow(0 0 1px rgba(0,0,0,0.2));
      color: var(--ink);
    }

    .ticket-body::before {
      content: "";
      position: absolute;
      inset: 0;
      border: 12px solid transparent;
      border-image: repeating-linear-gradient(
        45deg,
        var(--vintage-red) 0, var(--vintage-red) 15px,
        var(--paper-color) 15px, var(--paper-color) 25px,
        var(--royal-green) 25px, var(--royal-green) 40px
      ) 40;
      z-index: 5;
      pointer-events: none;
    }

    .ticket-stub {
      width: 100px;
      background: var(--royal-green);
      color: var(--paper-color);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Cinzel';
      font-size: 12px;
      letter-spacing: 4px;
      writing-mode: vertical-lr;
      border-left: 3px dashed rgba(255,255,255,0.1);
      z-index: 6;
      text-align:center;
      padding: 10px 0;
    }

    .ticket-main {
      flex: 1;
      padding: 28px 38px;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      z-index: 4;
    }

    .gold-foil-text {
      background: var(--gold-foil);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-family: 'Cinzel';
      font-weight: 900;
      letter-spacing: 3px;
    }

    .header-box { text-align: center; }
    .header-box h1 { font-size: 38px; margin: 0; }
    .header-box p {
      color: var(--vintage-red);
      font-size: 13px;
      font-weight: bold;
      letter-spacing: 5px;
      margin-top: 6px;
      text-transform: uppercase;
    }

    .center-content { text-align: center; }
    .center-content span { font-family: 'Cinzel'; font-size: 10px; color: var(--royal-green); opacity: 0.65; }
    .name-display {
      font-family: 'Great Vibes', cursive;
      font-size: 64px;
      color: var(--royal-green);
      margin: 4px 0 2px;
      filter: drop-shadow(1px 1px 0px white);
    }

    .meta-row{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top: 6px;
    }
    .chip{
      border:1px solid rgba(13,38,29,0.25);
      background: rgba(255,255,255,0.55);
      padding: 6px 10px;
      border-radius: 999px;
      font-family: 'Cinzel';
      font-size: 10px;
      letter-spacing: 1px;
      color: rgba(13,38,29,0.9);
    }
    .chip b{ color: var(--royal-green); }

    .footer-row {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      border-top: 1px solid rgba(0,0,0,0.12);
      padding-top: 18px;
      gap: 16px;
    }

    .barcode-section {
      text-align: center;
      cursor: pointer;
      padding: 8px 10px;
      transition: 0.3s;
      user-select: none;
    }
    .barcode-section:hover { transform: translateY(-4px); }

    .barcode-img {
      width: 180px;
      height: 45px;
      background: #000;
      mask: repeating-linear-gradient(90deg, #000 0, #000 2px, transparent 2px, transparent 6px);
      -webkit-mask: repeating-linear-gradient(90deg, #000 0, #000 2px, transparent 2px, transparent 6px);
      border-radius: 2px;
    }

    .mini-actions{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-start;
      flex-wrap:wrap;
      font-family: 'Cinzel';
      font-size: 10px;
      letter-spacing: 1px;
      color: rgba(0,0,0,0.55);
    }

    /* --- ÿ∑ÿ®ŸÇÿ© ÿßŸÑŸÉÿ¥ŸÅ --- */
    .reveal-overlay {
      position: absolute;
      inset: 0;
      background: var(--royal-green);
      z-index: 20;
      transform: translateY(100%);
      transition: transform 0.9s cubic-bezier(0.19, 1, 0.22, 1);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 34px;
      text-align: center;
      border: 8px solid #bf953f;
      color: var(--paper-color);
    }
    .ticket-outer.opened .reveal-overlay { transform: translateY(0); }

    .msg-ar { font-size: 22px; line-height: 1.9; margin: 0 0 14px; font-weight: 700; }
    .msg-en { font-family: 'Playfair Display'; font-size: 14px; color: #bf953f; font-style: italic; margin: 0; }

    .panel{
      border: 1px solid rgba(191,149,63,0.9);
      padding: 26px 24px;
      width: 100%;
      background: rgba(0,0,0,0.12);
    }

    .kpi{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin: 16px 0 14px;
      text-align: center;
    }
    .kpi .box{
      border: 1px solid rgba(242,230,208,0.2);
      padding: 10px 8px;
      background: rgba(255,255,255,0.05);
    }
    .kpi .label{
      font-family: 'Cinzel';
      letter-spacing: 2px;
      font-size: 9px;
      color: rgba(242,230,208,0.8);
    }
    .kpi .val{
      font-family: 'Cinzel';
      font-weight: 900;
      font-size: 16px;
      margin-top: 6px;
      color: #fcf6ba;
    }

    .reward{
      margin-top: 10px;
      border-top: 1px dashed rgba(242,230,208,0.25);
      padding-top: 12px;
      font-size: 14px;
      line-height: 1.8;
      color: rgba(242,230,208,0.95);
    }
    .code{
      margin-top: 12px;
      font-family: 'Cinzel';
      letter-spacing: 3px;
      font-size: 12px;
      color: rgba(252,246,186,0.95);
      user-select: all;
    }

    .close-btn {
      margin-top: 16px;
      background: none;
      border: 1px solid #bf953f;
      color: #bf953f;
      padding: 9px 18px;
      cursor: pointer;
      font-family: 'Cinzel';
      font-size: 10px;
      transition: 0.3s;
    }
    .close-btn:hover { background: #bf953f; color: #000; }

    /* ÿÆÿ™ŸÖ */
    .seal-gold {
      width: 80px;
      height: 80px;
      position: absolute;
      top: 50%;
      right: 15%;
      transform: translateY(-50%) rotate(-20deg);
      border-radius: 50%;
      background: var(--gold-foil);
      border: 2px solid #000;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Cinzel';
      font-weight: 900;
      box-shadow: 0 10px 20px rgba(0,0,0,0.3);
      opacity: 0.85;
      pointer-events: none;
    }

    /* ŸÖŸàÿ®ÿßŸäŸÑ */
    @media (max-width: 720px){
      .ticket-main{ padding: 20px 18px; }
      .name-display{ font-size: 52px; }
      .header-box h1{ font-size: 30px; }
      .ticket-stub{ width: 86px; font-size: 11px; }
      .barcode-img{ width: 160px; }
      .kpi{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <!-- Setup (only first time) -->
  <div id="setup" aria-hidden="true">
    <h2 class="gold-foil-text" style="font-size: 30px; margin:0;">ROYAL IDENTITY</h2>
    <p style="color: rgba(242,230,208,0.75); letter-spacing: 2px; margin: 10px 0 0;">AUTHENTICATING YOUR PRESENCE‚Ä¶</p>

    <input type="text" id="userName" class="input-style" placeholder="Your Name" maxlength="16">
    <div class="hint">
      Ÿáÿ∞Ÿá ŸÑŸäÿ≥ÿ™ ÿ®ÿ∑ÿßŸÇÿ© ÿÆÿµŸÖ‚Ä¶ Ÿáÿ∞Ÿá <b>ŸáŸàŸäÿ™ŸÉ</b> ŸÅŸä ÿßŸÑŸÖŸÉÿßŸÜ. <br>
      ÿ®ÿπÿØ ÿ•ÿµÿØÿßÿ±Ÿáÿßÿå ÿ£Ÿä ŸÇÿ±ÿßÿ°ÿ© ŸÑŸÑŸÄNFC ÿ®ÿ™ÿ∏Ÿáÿ± ÿ™ÿ∞ŸÉÿ±ÿ™ŸÉ ŸÖÿ®ÿßÿ¥ÿ±ÿ©.
    </div>

    <div class="row-actions">
      <button class="close-btn" style="font-size: 13px; padding: 12px 34px;" onclick="issueIdentity()">ÿ•ÿµÿØÿßÿ± ÿßŸÑŸáŸàŸäÿ©</button>
      <button class="close-btn" style="font-size: 13px; padding: 12px 22px; opacity:.9;" onclick="demoGuest()">ÿØÿÆŸàŸÑ ŸÉÿ∂ŸäŸÅ</button>
    </div>
  </div>

  <!-- Ticket -->
  <div class="ticket-outer" id="mainTicket" aria-live="polite">
    <div class="ticket-body">

      <div class="ticket-stub" id="stubText">
        ‚Ññ 7721-09-2025 ‚Ä¢ ADMIT ONE
      </div>

      <div class="ticket-main">
        <div class="header-box">
          <h1 class="gold-foil-text" id="headline">ROYAL MEMBER</h1>
          <p id="subhead">GRAND WINTER GALA 2025</p>
        </div>

        <div class="center-content">
          <span>EXCLUSIVE ENTRY GRANTED TO</span>
          <div class="name-display" id="displayName">Guest</div>
          <div style="height: 1px; width: 110px; background: #bf953f; margin: 10px auto;"></div>

          <div class="meta-row">
            <div class="chip">VISITS: <b id="visitsChip">0</b></div>
            <div class="chip">STAMPS: <b id="stampsChip">0</b>/12</div>
            <div class="chip">TIER: <b id="tierChip">BRONZE</b></div>
          </div>
        </div>

        <div class="footer-row">
          <div style="text-align: left; color: #444; font-size: 11px; font-family: 'Cinzel'; min-width: 180px;">
            REF: <span id="refCode">ROYAL-882</span><br>
            STATUS: <span id="statusText">CONFIRMED</span>
            <div class="mini-actions" style="margin-top:8px;">
              <span style="opacity:.9;">Last:</span> <span id="lastSeen">‚Äî</span>
              <button class="close-btn" style="margin:0; padding:6px 10px; font-size:9px;" onclick="editName()">ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿßÿ≥ŸÖ</button>
              <button class="close-btn" style="margin:0; padding:6px 10px; font-size:9px; border-color: rgba(191,149,63,0.7);" onclick="resetIdentity()">ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ</button>
            </div>
          </div>

          <div class="barcode-section" onclick="openTicket()">
            <div class="barcode-img"></div>
            <div style="font-size: 9px; margin-top: 6px; color: var(--vintage-red); font-weight: bold; letter-spacing: 1px;">
              CLICK BARCODE TO REVEAL TODAY‚ÄôS ROYAL SEAL
            </div>
          </div>
        </div>

        <div class="seal-gold">L</div>
      </div>

      <!-- Reveal -->
      <div class="reveal-overlay" id="reveal">
        <div class="panel">
          <p class="msg-ar" id="arMsg">ÿ£ŸáŸÑÿßŸã ÿ®ŸÉ‚Ä¶</p>
          <p class="msg-en" id="enMsg">Welcome‚Ä¶</p>

          <div class="kpi">
            <div class="box">
              <div class="label">VISITS</div>
              <div class="val" id="kpiVisits">0</div>
            </div>
            <div class="box">
              <div class="label">STAMPS</div>
              <div class="val" id="kpiStamps">0/12</div>
            </div>
            <div class="box">
              <div class="label">TIER</div>
              <div class="val" id="kpiTier">BRONZE</div>
            </div>
          </div>

          <div class="reward" id="rewardBox" style="display:none;"></div>
          <div class="code" id="cashierCode" title="ÿßŸÜÿ≥ÿÆŸá ŸÑŸÑŸÉÿßÿ¥Ÿäÿ±"></div>

          <div style="font-family: 'Great Vibes'; font-size: 34px; color: #bf953f; margin-top: 14px;">Lano</div>

          <button class="close-btn" onclick="closeTicket()">ÿ•ÿ∫ŸÑÿßŸÇ</button>
        </div>
      </div>

    </div>
  </div>

<script>
  // =========================
  // Royal Identity (LocalStorage)
  // =========================
  const STORAGE_KEY = "lano_royal_identity_v1";
  const VISIT_COOLDOWN_HOURS = 4; // ŸÑÿß Ÿäÿ≤ŸäÿØ ÿßŸÑÿ≤Ÿäÿßÿ±ÿ© ÿ•ŸÑÿß ÿ®ÿπÿØ 4 ÿ≥ÿßÿπÿßÿ™ (ÿ™ŸÇÿØÿ± ÿ™ÿ∫ŸäŸëÿ±Ÿáÿß)

  // ÿ±ÿ≥ÿßÿ¶ŸÑ ÿ≠ÿ≥ÿ® ŸÖÿ±ÿßÿ≠ŸÑ ÿßŸÑÿ≤Ÿäÿßÿ±ÿ©
  function stageMessages(visits){
    if (visits <= 1) return {
      ar: "ŸÖÿ±ÿ≠ÿ®Ÿãÿß ÿ®ŸÉ‚Ä¶ ÿßŸÑŸäŸàŸÖ ÿ®ÿØÿ£ÿ™ ŸáŸàŸäÿ™ŸÉ ÿßŸÑŸÖŸÑŸÉŸäÿ© ŸÖÿπŸÜÿß ‚ú®",
      en: "Welcome‚Ä¶ your Royal Identity begins today ‚ú®"
    };
    if (visits <= 3) return {
      ar: "Ÿàÿ¨ŸàÿØŸÉ ÿµÿßÿ± ŸÑŸá ÿ£ÿ´ÿ±‚Ä¶ ŸÜÿ≠ŸÜ ŸÜŸÑÿßÿ≠ÿ∏ ÿ™ŸÅÿßÿµŸäŸÑ ÿ±ÿ¨ÿπÿ™ŸÉ ü§ç",
      en: "Your presence leaves a trace‚Ä¶ we notice your return ü§ç"
    };
    if (visits <= 6) return {
      ar: "ÿ£ŸÜÿ™ ÿßŸÑÿ¢ŸÜ ŸÖŸÜ ÿßŸÑŸàÿ¨ŸàŸá ÿßŸÑŸÖÿ£ŸÑŸàŸÅÿ©‚Ä¶ ÿ£ŸáŸÑÿßŸã ÿ®ŸÉ ŸÅŸä ÿØÿßÿ¶ÿ±ÿ™ŸÜÿß ÿßŸÑÿÆÿßÿµÿ© üëë",
      en: "You‚Äôre becoming a familiar face‚Ä¶ welcome to our inner circle üëë"
    };
    if (visits <= 10) return {
      ar: "ŸàŸÑÿßÿ§ŸÉ Ÿàÿßÿ∂ÿ≠‚Ä¶ ŸàŸáÿ∞Ÿá ŸÑŸäÿ≥ÿ™ ÿµÿØŸÅÿ©ÿå Ÿáÿ∞Ÿá ÿπÿßÿØÿ© ÿ¨ŸÖŸäŸÑÿ© ‚ú®",
      en: "Your loyalty shows‚Ä¶ not luck, a beautiful habit ‚ú®"
    };
    return {
      ar: "ÿ£ŸÜÿ™ ŸÖŸÜ ÿ£ŸáŸÑ ÿßŸÑŸÖŸÉÿßŸÜ‚Ä¶ ÿ™ÿ∞ŸÉÿ±ÿ™ŸÉ ŸÖÿß ÿπÿßÿØÿ™ ÿ™ÿ∞ŸÉÿ±ÿ©ÿå ÿµÿßÿ±ÿ™ ŸáŸàŸäÿ© üëë",
      en: "You belong here‚Ä¶ this ticket is no longer a ticket, it‚Äôs an identity üëë"
    };
  }

  // ŸÖŸÉÿßŸÅÿ¢ÿ™ ÿπŸÑŸâ ŸÖÿ≠ÿ∑ÿßÿ™ (ŸÇÿßÿ®ŸÑÿ© ŸÑŸÑÿ™ÿπÿØŸäŸÑ ÿ≠ÿ≥ÿ® ŸáÿßŸÖÿ¥ ÿßŸÑÿ±ÿ®ÿ≠)
  function milestoneReward(visits){
    const map = {
      3:  { ar: "üéñÔ∏è ŸÖŸÉÿßŸÅÿ£ÿ©: ÿ•ÿ∂ÿßŸÅÿ© (ÿµŸàÿµ/ÿ™Ÿàÿ®ŸÜŸÇ) ŸÖÿ¨ÿßŸÜŸãÿß ÿßŸÑŸäŸàŸÖ.", en: "üéñÔ∏è Reward: a free add-on today." },
      6:  { ar: "üëë ŸÖŸÉÿßŸÅÿ£ÿ©: Upgrade ÿ≠ÿ¨ŸÖ/ÿ•ÿ∂ÿßŸÅÿ© ÿÆÿßÿµÿ© (ÿ≠ÿ≥ÿ® ÿßŸÑŸÖÿ™ÿßÿ≠).", en: "üëë Reward: an upgrade (subject to availability)." },
      9:  { ar: "‚ú® ŸÖŸÉÿßŸÅÿ£ÿ©: ÿ≠ŸÑŸàŸâ ÿµÿ∫Ÿäÿ±ÿ© ÿ£Ÿà ŸÖÿ¥ÿ±Ÿàÿ® ÿµÿ∫Ÿäÿ± (ÿ≠ÿ≥ÿ® ÿßŸÑŸÖÿ™ÿßÿ≠).", en: "‚ú® Reward: a small dessert/drink (subject to availability)." },
      12: { ar: "üèÜ ŸÖŸÉÿßŸÅÿ£ÿ©: ÿßŸÖÿ™Ÿäÿßÿ≤ ŸÖŸÑŸÉŸä ‚Äî ŸÖŸÜÿ™ÿ¨ ŸÖÿ¨ÿßŸÜŸä ŸÖÿ≠ÿØÿØ + ÿÆÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿπŸäŸäŸÜ.", en: "üèÜ Reward: royal privilege ‚Äî a selected free item + reset stamp." }
    };
    return map[visits] || null;
  }

  // Lucky Winner probability (Ÿäÿ≤ŸäÿØ ÿÆÿßÿ±ÿ¨ ÿßŸÑÿ∞ÿ±Ÿàÿ© ŸÉŸÖÿ´ÿßŸÑ)
  function isLuckyWinner(){
    const h = new Date().getHours();
    const offPeak = (h < 16 || h >= 22); // ŸÇÿ®ŸÑ 4ŸÖ ÿ£Ÿà ÿ®ÿπÿØ 10ŸÖ
    const p = offPeak ? 0.10 : 0.05;     // 10% ÿÆÿßÿ±ÿ¨ ÿßŸÑÿ∞ÿ±Ÿàÿ©ÿå 5% ÿØÿßÿÆŸÑŸáÿß
    return Math.random() < p;
  }

  function luckyReward(){
    const rewards = [
      { ar: "üéâ LUCKY WINNER: ÿ¥Ÿàÿ™ ŸÇŸáŸàÿ© ÿ£Ÿà ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ¨ÿßŸÜŸäÿ© ÿßŸÑŸäŸàŸÖ.", en: "üéâ LUCKY WINNER: free coffee shot or add-on today." },
      { ar: "üéâ LUCKY WINNER: ÿÆÿµŸÖ 20% ÿπŸÑŸâ ŸÖŸÜÿ™ÿ¨ Ÿàÿßÿ≠ÿØ (ÿ∫Ÿäÿ± ŸÇÿßÿ®ŸÑ ŸÑŸÑÿ¨ŸÖÿπ).", en: "üéâ LUCKY WINNER: 20% off one item (not stackable)." },
      { ar: "üéâ LUCKY WINNER: ÿ≠ŸÑŸàŸâ ÿßŸÑŸäŸàŸÖ (ÿ≠ÿ≥ÿ® ÿßŸÑŸÖÿ™ÿßÿ≠).", en: "üéâ LUCKY WINNER: dessert of the day (subject to availability)." }
    ];
    return rewards[Math.floor(Math.random()*rewards.length)];
  }

  function tierFromVisits(v){
    if (v >= 12) return "DIAMOND";
    if (v >= 9)  return "GOLD";
    if (v >= 6)  return "SILVER";
    return "BRONZE";
  }

  function stampsFromVisits(v){
    // 12 ÿÆÿ™ŸÖ ÿ´ŸÖ ÿ™ÿπŸäÿØ (ŸÑŸÉŸÜ ÿßŸÑÿ≤Ÿäÿßÿ±ÿßÿ™ ÿ™ÿ∏ŸÑ ÿ™ÿ™ÿ±ÿßŸÉŸÖ)
    const s = v % 12;
    return s === 0 && v > 0 ? 12 : s;
  }

  function formatLastSeen(ts){
    if(!ts) return "‚Äî";
    const d = new Date(ts);
    return d.toLocaleString("ar-SA", { weekday: "short", day: "2-digit", month: "short", hour: "2-digit", minute:"2-digit" });
  }

  function randomId(len=10){
    const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let out = "";
    for(let i=0;i<len;i++) out += chars[Math.floor(Math.random()*chars.length)];
    return out;
  }

  function hashCode(str){
    // simple deterministic hash
    let h = 0;
    for(let i=0;i<str.length;i++){
      h = (h<<5) - h + str.charCodeAt(i);
      h |= 0;
    }
    return Math.abs(h);
  }

  function makeCashierCode(profile){
    const now = new Date();
    const dayKey = `${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}`;
    const base = `${profile.id}|${profile.name}|${profile.visits}|${dayKey}`;
    const code = (hashCode(base).toString(36).toUpperCase()).slice(0,8);
    return `LANO-${code}`;
  }

  function loadProfile(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(!obj || !obj.id || !obj.name) return null;
      return obj;
    }catch(e){
      return null;
    }
  }

  function saveProfile(p){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(p));
  }

  function showSetup(){
    const setup = document.getElementById("setup");
    setup.style.display = "block";
    setup.setAttribute("aria-hidden", "false");
    document.getElementById("userName").focus();
  }

  function hideSetup(){
    const setup = document.getElementById("setup");
    setup.classList.add("fade-out");
    setup.setAttribute("aria-hidden", "true");
  }

  function activateTicket(){
    setTimeout(() => {
      document.getElementById("mainTicket").classList.add("active");
    }, 350);
  }

  function renderTicket(profile){
    // Visual fields
    document.getElementById("displayName").innerText = profile.name;
    document.getElementById("refCode").innerText = `ROYAL-${profile.id.slice(0,4)}${profile.id.slice(-2)}`;
    document.getElementById("statusText").innerText = "CONFIRMED";
    document.getElementById("lastSeen").innerText = formatLastSeen(profile.lastSeen);

    const tier = tierFromVisits(profile.visits);
    const stamps = stampsFromVisits(profile.visits);

    document.getElementById("visitsChip").innerText = profile.visits;
    document.getElementById("stampsChip").innerText = stamps;
    document.getElementById("tierChip").innerText = tier;

    // Stub refresh
    const stub = document.getElementById("stubText");
    stub.innerText = `‚Ññ ${profile.id.slice(0,4)}-${String(profile.visits).padStart(2,"0")} ‚Ä¢ ADMIT ONE`;

    // Header changes (premium feel)
    const headline = document.getElementById("headline");
    headline.innerText = (tier === "DIAMOND") ? "ROYAL LEGEND" : "ROYAL MEMBER";

    const subhead = document.getElementById("subhead");
    subhead.innerText = (tier === "DIAMOND") ? "EXCLUSIVE PRIVILEGE GRANTED" : "GRAND WINTER GALA 2025";
  }

  function shouldCountVisit(profile){
    const now = Date.now();
    if(!profile.lastScanAt) return true;
    const diffMs = now - profile.lastScanAt;
    const diffHours = diffMs / (1000*60*60);
    return diffHours >= VISIT_COOLDOWN_HOURS;
  }

  function applyScan(profile){
    const now = Date.now();
    const counted = shouldCountVisit(profile);

    profile.lastSeen = now;

    if(counted){
      profile.visits = (profile.visits || 0) + 1;
      profile.lastScanAt = now;
      profile.totalScans = (profile.totalScans || 0) + 1;
    }else{
      // still track scans but not visits
      profile.totalScans = (profile.totalScans || 0) + 1;
    }

    saveProfile(profile);
    return { counted };
  }

  // ========= Actions =========
  function issueIdentity(){
    const name = (document.getElementById("userName").value || "").trim();
    if(!name){
      document.getElementById("userName").style.borderBottomColor = "#ffcf74";
      return;
    }

    const profile = {
      id: randomId(10),
      name,
      visits: 0,
      createdAt: Date.now(),
      lastSeen: null,
      lastScanAt: null,
      totalScans: 0
    };

    saveProfile(profile);
    hideSetup();

    renderTicket(profile);
    activateTicket();
  }

  function demoGuest(){
    const profile = {
      id: "GUEST" + randomId(6),
      name: "Guest",
      visits: 0,
      createdAt: Date.now(),
      lastSeen: null,
      lastScanAt: null,
      totalScans: 0,
      _demo: true
    };
    // ŸÑÿß ŸÜÿ≠ŸÅÿ∏ ÿßŸÑÿ∂ŸäŸÅ
    document.getElementById("setup").style.display = "none";
    renderTicket(profile);
    activateTicket();
    window.__demoProfile = profile;
  }

  function resetIdentity(){
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  }

  function editName(){
    const p = loadProfile();
    if(!p){
      // demo
      const newName = prompt("ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖŸÉ:", "Guest");
      if(newName && newName.trim()){
        window.__demoProfile.name = newName.trim();
        renderTicket(window.__demoProfile);
      }
      return;
    }
    const newName = prompt("ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖŸÉ:", p.name);
    if(newName && newName.trim()){
      p.name = newName.trim();
      saveProfile(p);
      renderTicket(p);
    }
  }

  function openTicket(){
    const outer = document.getElementById("mainTicket");
    outer.classList.add("opened");

    // load profile
    let profile = loadProfile();
    if(!profile){
      // demo fallback
      profile = window.__demoProfile || { id: randomId(8), name: "Guest", visits: 0 };
    }else{
      // apply scan (visit increment with cooldown)
      applyScan(profile);
    }

    // refresh UI
    renderTicket(profile);

    // Build reveal content
    const tier = tierFromVisits(profile.visits);
    const stamps = stampsFromVisits(profile.visits);
    const stage = stageMessages(profile.visits);

    document.getElementById("arMsg").innerText = stage.ar;
    document.getElementById("enMsg").innerText = stage.en;

    document.getElementById("kpiVisits").innerText = profile.visits;
    document.getElementById("kpiStamps").innerText = `${stamps}/12`;
    document.getElementById("kpiTier").innerText = tier;

    // Reward logic: milestone OR lucky winner
    const rewardBox = document.getElementById("rewardBox");
    rewardBox.style.display = "none";
    rewardBox.innerText = "";

    let reward = milestoneReward(profile.visits);

    // Lucky Winner (if no milestone, or even alongside it‚ÄîÿßÿÆÿ™Ÿäÿßÿ±Ÿä)
    if(!reward && isLuckyWinner()){
      reward = luckyReward();
    }

    if(reward){
      rewardBox.style.display = "block";
      rewardBox.innerText = reward.ar + "\n" + reward.en;
    }

    // Cashier code (daily-ish)
    const code = makeCashierCode(profile);
    document.getElementById("cashierCode").innerText = `CODE: ${code}`;
  }

  function closeTicket(){
    document.getElementById("mainTicket").classList.remove("opened");
  }

  // ========= Boot =========
  (function init(){
    const profile = loadProfile();
    if(profile){
      document.getElementById("setup").style.display = "none";
      renderTicket(profile);
      activateTicket();
    }else{
      showSetup();
    }
  })();
</script>

</body>
</html>
